<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thirdgroup.cdms.mapper.OrderMapper">

    <!-- 1. 查待接单订单：不变 -->
    <select id="selectPendingOrders" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
            order_id AS orderId,
            sender_name AS senderName,
            sender_phone AS senderPhone,
            sender_address AS senderAddress,
            consignee_name AS consigneeName,
            consignee_phone AS consigneePhone,
            consignee_address AS consigneeAddress,
            goods_type AS goodsType,
            weight,
            volume,
            delivery_fee AS deliveryFee,
            platform_income AS platformIncome,
            deliveryman_income AS deliverymanIncome,
            expected_mins AS expectedMins,
            remark,
            status,
            create_time AS createTime,
            creator_id AS creatorId,
            deliveryman_id AS deliverymanId,
            complete_time AS completeTime,
            cancel_time AS cancelTime
        FROM cdms_delivery_order
        WHERE status = #{status,jdbcType=INTEGER}
          AND deliveryman_id IS NULL
        ORDER BY create_time DESC
    </select>

    <!-- 2. 根据骑手ID+状态查订单：不变 -->
    <select id="selectByStatusAndDeliveryman" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
            order_id AS orderId,
            sender_name AS senderName,
            sender_phone AS senderPhone,
            sender_address AS senderAddress,
            consignee_name AS consigneeName,
            consignee_phone AS consigneePhone,
            consignee_address AS consigneeAddress,
            goods_type AS goodsType,
            weight,
            volume,
            delivery_fee AS deliveryFee,
            platform_income AS platformIncome,
            deliveryman_income AS deliverymanIncome,
            expected_mins AS expectedMins,
            remark,
            status,
            create_time AS createTime,
            creator_id AS creatorId,
            deliveryman_id AS deliverymanId,
            complete_time AS completeTime,
            cancel_time AS cancelTime
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
          AND status = #{status,jdbcType=INTEGER}
        ORDER BY create_time DESC
    </select>

    <!-- 3. 接单：删除update_time更新（核心修改） -->
    <update id="acceptOrder">
        UPDATE cdms_delivery_order
        SET
        deliveryman_id = #{deliverymanId,jdbcType=BIGINT},  -- 保留骑手ID更新
        status = #{targetStatus,jdbcType=INTEGER}           -- 保留状态更新
        <!-- 移除：update_time = NOW()（数据库无此字段） -->
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
        AND status = 0
        AND deliveryman_id IS NULL
    </update>

    <!-- 4. 更新订单状态：删除update_time更新（核心修改） -->
    <update id="updateStatus">
        UPDATE cdms_delivery_order
        SET
        status = #{targetStatus,jdbcType=INTEGER}  -- 保留状态更新
        <!-- 移除：update_time = #{updateTime,jdbcType=TIMESTAMP}（数据库无此字段） -->
        <if test="targetStatus == 3">
            , complete_time = NOW()  <!-- 保留完成时间更新（业务必要） -->
        </if>
        <if test="targetStatus == 4">
            , cancel_time = NOW()   <!-- 保留取消时间更新（业务必要） -->
        </if>
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
    </update>

    <!-- 5. 根据ID查订单：不变 -->
    <select id="selectById" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
            order_id AS orderId,
            sender_name AS senderName,
            sender_phone AS senderPhone,
            sender_address AS senderAddress,
            consignee_name AS consigneeName,
            consignee_phone AS consigneePhone,
            consignee_address AS consigneeAddress,
            goods_type AS goodsType,
            weight,
            volume,
            delivery_fee AS deliveryFee,
            platform_income AS platformIncome,
            deliveryman_income AS deliverymanIncome,
            expected_mins AS expectedMins,
            remark,
            status,
            create_time AS createTime,
            creator_id AS creatorId,
            deliveryman_id AS deliverymanId,
            complete_time AS completeTime,
            cancel_time AS cancelTime
        FROM cdms_delivery_order
        WHERE order_id = #{orderId,jdbcType=VARCHAR}
    </select>

    <!-- 6. 分页查询订单：不变 -->
    <select id="selectPage" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        order_id AS orderId,
        sender_name AS senderName,
        sender_phone AS senderPhone,
        sender_address AS senderAddress,
        consignee_name AS consigneeName,
        consignee_phone AS consigneePhone,
        consignee_address AS consigneeAddress,
        goods_type AS goodsType,
        weight,
        volume,
        delivery_fee AS deliveryFee,
        platform_income AS platformIncome,
        deliveryman_income AS deliverymanIncome,
        expected_mins AS expectedMins,
        remark,
        status,
        create_time AS createTime,
        creator_id AS creatorId,
        deliveryman_id AS deliverymanId,
        complete_time AS completeTime,
        cancel_time AS cancelTime
        FROM cdms_delivery_order
        <where>
            <if test="status != null">
                AND status = #{status,jdbcType=INTEGER}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                order_id LIKE #{keyword,jdbcType=VARCHAR}
                OR sender_name LIKE #{keyword,jdbcType=VARCHAR}
                OR consignee_name LIKE #{keyword,jdbcType=VARCHAR}
                )
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <!-- 7. 兼容历史方法：不变 -->
    <select id="selectDeliveringByCourierId" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
            order_id AS orderId,
            sender_name AS senderName,
            sender_phone AS senderPhone,
            sender_address AS senderAddress,
            consignee_name AS consigneeName,
            consignee_phone AS consigneePhone,
            consignee_address AS consigneeAddress,
            goods_type AS goodsType,
            weight,
            volume,
            delivery_fee AS deliveryFee,
            platform_income AS platformIncome,
            deliveryman_income AS deliverymanIncome,
            expected_mins AS expectedMins,
            remark,
            status,
            create_time AS createTime,
            creator_id AS creatorId,
            deliveryman_id AS deliverymanId,
            complete_time AS completeTime,
            cancel_time AS cancelTime
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
          AND status = #{status,jdbcType=INTEGER}
    </select>
    <update id="updateDeliverymanIncomeAndCompleteTime">
        UPDATE cdms_delivery_order
        SET
            deliveryman_income = #{deliverymanIncome,jdbcType=DECIMAL},  -- 写入配送员收益
            complete_time = #{completeTime,jdbcType=TIMESTAMP},          -- 写入完成时间
            status = 3                                                   -- 确保状态为“已完成”（3对应已完成）
        WHERE
            order_id = #{orderId,jdbcType=VARCHAR}                       -- 匹配String类型订单ID
          AND deliveryman_id IS NOT NULL                                -- 确保订单已分配骑手
    </update>
</mapper>