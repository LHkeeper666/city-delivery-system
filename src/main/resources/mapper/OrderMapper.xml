<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thirdgroup.cdms.mapper.OrderMapper">
    <sql id="BaseColumnList">
        id, order_no, shop_name, shop_address, shop_phone,
        user_address, user_phone, profit, distance, status,
        courier_id, create_time, accept_time, complete_time, take_meal_time  <!-- 新增取餐时间字段 -->
    </sql>

    <!-- 1. 查待接单订单（status=0，按距离升序） -->
    <select id="selectPendingOrders" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE status = #{status}  <!-- 传入OrderStatus.PENDING.getCode() -->
        ORDER BY distance ASC
    </select>

    <!-- 2. 按外卖员ID和状态查订单（支持查“已接单待取货”和“配送中”） -->
    <select id="selectByCourierIdAndStatus" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE courier_id = #{courierId}
        AND status = #{status}  <!-- 可传入1（ACCEPTED）或2（IN_TRANSIT） -->
        ORDER BY create_time DESC
    </select>

    <!-- 3. 接单：更新订单的外卖员ID、状态、接单时间（防重复接单） -->
    <update id="acceptOrder">
        UPDATE delivery_order
        SET
        courier_id = #{courierId},
        status = #{targetStatus},  <!-- 目标状态：ACCEPTED(1) -->
        accept_time = NOW()  <!-- 记录接单时间 -->
        WHERE id = #{orderId}
        AND status = #{pendingStatus}  <!-- 仅允许待接单（PENDING=0）的订单被接 -->
    </update>

    <!-- 4. 更新订单状态（确认取餐/送达） -->
    <update id="updateStatus">
        UPDATE delivery_order
        SET status = #{status}
        <if test="status == 2">, take_meal_time = #{acceptTime}</if>  <!-- 配送中（IN_TRANSIT=2）：记录取餐时间 -->
        <if test="status == 3">, complete_time = #{completeTime}</if>  <!-- 已完成（COMPLETED=3）：记录完成时间 -->
        WHERE id = #{orderId}
    </update>

    <!-- 5. 根据ID查订单 -->
    <select id="selectById" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE id = #{orderId}
    </select>

    <!-- 6. 查外卖员的已完成订单 -->
    <select id="selectCompletedByCourierId" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE courier_id = #{courierId}
        AND status = #{status}  <!-- 传入OrderStatus.COMPLETED.getCode() -->
        ORDER BY complete_time DESC
    </select>
</mapper>