<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thirdgroup.cdms.mapper.OrderMapper">

    <!-- 结果集映射：统一管理字段映射关系，避免重复编写 -->
    <resultMap id="DeliveryOrderResultMap" type="com.thirdgroup.cdms.model.DeliveryOrder">
        <id column="order_id" property="orderId" jdbcType="VARCHAR"/>
        <result column="sender_name" property="senderName" jdbcType="VARCHAR"/>
        <result column="sender_phone" property="senderPhone" jdbcType="VARCHAR"/>
        <result column="sender_address" property="senderAddress" jdbcType="VARCHAR"/>
        <result column="consignee_name" property="consigneeName" jdbcType="VARCHAR"/>
        <result column="consignee_phone" property="consigneePhone" jdbcType="VARCHAR"/>
        <result column="consignee_address" property="consigneeAddress" jdbcType="VARCHAR"/>
        <result column="goods_type" property="goodsType" jdbcType="VARCHAR"/>
        <result column="weight" property="weight" jdbcType="DECIMAL"/>
        <result column="volume" property="volume" jdbcType="DECIMAL"/>
        <result column="delivery_fee" property="deliveryFee" jdbcType="DECIMAL"/>
        <result column="platform_income" property="platformIncome" jdbcType="DECIMAL"/>
        <result column="deliveryman_income" property="deliverymanIncome" jdbcType="DECIMAL"/>
        <result column="expected_mins" property="expectedMins" jdbcType="INTEGER"/>
        <result column="remark" property="remark" jdbcType="VARCHAR"/>
        <result column="status" property="status" jdbcType="INTEGER"/>
        <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="creator_id" property="creatorId" jdbcType="BIGINT"/>
        <result column="deliveryman_id" property="deliverymanId" jdbcType="BIGINT"/>
        <result column="complete_time" property="completeTime" jdbcType="TIMESTAMP"/>
        <result column="cancel_time" property="cancelTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 1. 查待接单订单：补充状态判断（待接单通常为状态0） -->
    <select id="selectPendingOrders" resultMap="DeliveryOrderResultMap">
        SELECT
        order_id,
        sender_name,
        sender_phone,
        sender_address,
        consignee_name,
        consignee_phone,
        consignee_address,
        goods_type,
        weight,
        volume,
        delivery_fee,
        platform_income,
        deliveryman_income,
        expected_mins,
        remark,
        status,
        create_time,
        creator_id,
        deliveryman_id,
        complete_time,
        cancel_time
        FROM cdms_delivery_order
        WHERE status = #{status,jdbcType=INTEGER}
        AND deliveryman_id IS NULL
        AND status = 0  <!-- 明确待接单状态为0，避免传入错误状态 -->
        ORDER BY create_time DESC
    </select>

    <!-- 2. 根据骑手ID+状态查订单：优化排序 -->
    <select id="selectByStatusAndDeliveryman" resultMap="DeliveryOrderResultMap">
        SELECT
        order_id,
        sender_name,
        sender_phone,
        sender_address,
        consignee_name,
        consignee_phone,
        consignee_address,
        goods_type,
        weight,
        volume,
        delivery_fee,
        platform_income,
        deliveryman_income,
        expected_mins,
        remark,
        status,
        create_time,
        creator_id,
        deliveryman_id,
        complete_time,
        cancel_time
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
        AND status = #{status,jdbcType=INTEGER}
        AND deliveryman_id IS NOT NULL  <!-- 确保骑手ID有效 -->
        ORDER BY
        CASE status
        WHEN 1 THEN 0  <!-- 配送中优先展示 -->
        WHEN 2 THEN 1  <!-- 待取货其次 -->
        ELSE 2
        END,
        create_time DESC
    </select>

    <!-- 3. 接单：增加乐观锁判断，防止重复接单 -->
    <update id="acceptOrder">
        UPDATE cdms_delivery_order
        SET
        deliveryman_id = #{deliverymanId,jdbcType=BIGINT},
        status = #{targetStatus,jdbcType=INTEGER}
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
        AND status = 0  <!-- 仅待接单状态可被接 -->
        AND deliveryman_id IS NULL
        AND #{targetStatus,jdbcType=INTEGER} IN (1,2)  <!-- 限制目标状态为有效接单状态 -->
    </update>

    <!-- 4. 更新订单状态：细化状态逻辑，防止非法状态变更 -->
    <update id="updateStatus">
        UPDATE cdms_delivery_order
        SET
        status = #{targetStatus,jdbcType=INTEGER}
        <if test="targetStatus == 3">
            , complete_time = CURRENT_TIMESTAMP  <!-- 完成状态更新完成时间 -->
        </if>
        <if test="targetStatus == 4">
            , cancel_time = CURRENT_TIMESTAMP   <!-- 取消状态更新取消时间 -->
        </if>
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
        <choose>
            <when test="targetStatus == 2">
                AND status = 1  <!-- 只有已接单待取货可转配送中 -->
            </when>
            <when test="targetStatus == 3">
                AND status IN (1, 2)  <!-- 只有已接单待取货/配送中可转完成 -->
            </when>
            <when test="targetStatus == 4">
                AND status IN (0, 1, 2)  <!-- 待接单/已接单待取货/配送中可取消 -->
            </when>
            <otherwise>
                AND status = status  <!-- 其他状态允许当前状态更新 -->
            </otherwise>
        </choose>
    </update>

    <!-- 5. 根据ID查订单：确保订单存在性 -->
    <select id="selectById" resultMap="DeliveryOrderResultMap">
        SELECT
        order_id,
        sender_name,
        sender_phone,
        sender_address,
        consignee_name,
        consignee_phone,
        consignee_address,
        goods_type,
        weight,
        volume,
        delivery_fee,
        platform_income,
        deliveryman_income,
        expected_mins,
        remark,
        status,
        create_time,
        creator_id,
        deliveryman_id,
        complete_time,
        cancel_time
        FROM cdms_delivery_order
        WHERE order_id = #{orderId,jdbcType=VARCHAR}
        AND order_id IS NOT NULL  <!-- 过滤无效ID查询 -->
    </select>

    <!-- 6. 分页查询订单：修复模糊查询语法 -->
    <select id="selectPage" resultMap="DeliveryOrderResultMap">
        SELECT
        order_id,
        sender_name,
        sender_phone,
        sender_address,
        consignee_name,
        consignee_phone,
        consignee_address,
        goods_type,
        weight,
        volume,
        delivery_fee,
        platform_income,
        deliveryman_income,
        expected_mins,
        remark,
        status,
        create_time,
        creator_id,
        deliveryman_id,
        complete_time,
        cancel_time
        FROM cdms_delivery_order
        <where>
            <if test="status != null">
                AND status = #{status,jdbcType=INTEGER}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                order_id LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%')
                OR sender_name LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%')
                OR consignee_name LIKE CONCAT('%', #{keyword,jdbcType=VARCHAR}, '%')
                )
            </if>
        </where>
        ORDER BY create_time DESC
        LIMIT #{start,jdbcType=INTEGER}, #{size,jdbcType=INTEGER}
    </select>

    <!-- 7. 兼容历史方法：保持原有逻辑 -->
    <select id="selectDeliveringByCourierId" resultMap="DeliveryOrderResultMap">
        SELECT
            order_id,
            sender_name,
            sender_phone,
            sender_address,
            consignee_name,
            consignee_phone,
            consignee_address,
            goods_type,
            weight,
            volume,
            delivery_fee,
            platform_income,
            deliveryman_income,
            expected_mins,
            remark,
            status,
            create_time,
            creator_id,
            deliveryman_id,
            complete_time,
            cancel_time
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
          AND status = #{status,jdbcType=INTEGER}
          AND deliveryman_id IS NOT NULL
    </select>

    <!-- 8. 更新收益与完成时间 -->
    <update id="updateDeliverymanIncomeAndCompleteTime">
        UPDATE cdms_delivery_order
        SET
        deliveryman_income = #{deliverymanIncome,jdbcType=DECIMAL},
        complete_time = #{completeTime,jdbcType=TIMESTAMP},
        status = 3  <!-- 强制更新为已完成状态 -->
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
        AND deliveryman_id IS NOT NULL  <!-- 确保已分配骑手 -->
        AND status IN (1, 2)  <!-- 仅配送中/待取货状态可完成 -->
        AND #{deliverymanIncome,jdbcType=DECIMAL} >= 0  <!-- 收益不能为负 -->
    </update>
    <!-- ✅ 9. 新增：统计骑手完成订单数量 -->
    <select id="countCompletedByDeliverymanId" resultType="int">
        SELECT COUNT(*)
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
        AND status = 3  <!-- 假设 3 表示"已完成" -->
    </select>
    
    <!-- ✅ 10. 新增：查询指定时间范围内骑手已完成的订单 -->
    <select id="selectCompletedByDeliverymanIdAndDateRange" resultMap="DeliveryOrderResultMap">
        SELECT
        order_id,
        sender_name,
        sender_phone,
        sender_address,
        consignee_name,
        consignee_phone,
        consignee_address,
        goods_type,
        weight,
        volume,
        delivery_fee,
        platform_income,
        deliveryman_income,
        expected_mins,
        remark,
        status,
        create_time,
        creator_id,
        deliveryman_id,
        complete_time,
        cancel_time
        FROM cdms_delivery_order
        WHERE deliveryman_id = #{deliverymanId,jdbcType=BIGINT}
        AND status = 3  <!-- 已完成状态 -->
        AND complete_time BETWEEN #{startTime,jdbcType=TIMESTAMP} AND #{endTime,jdbcType=TIMESTAMP}
        ORDER BY complete_time DESC
    </select>

    <!-- 10. 更新订单状态和放弃信息 -->
    <update id="updateOrderWithAbandonInfo">
        UPDATE cdms_delivery_order
        SET
        status = #{targetStatus,jdbcType=INTEGER},
        abandon_reason = #{abandonReason,jdbcType=VARCHAR},
        abandon_description = #{abandonDescription,jdbcType=VARCHAR},
        cancel_time = CURRENT_TIMESTAMP
        WHERE
        order_id = #{orderId,jdbcType=VARCHAR}
        AND status IN (1, 2)  <!-- 只有配送中或待取货状态的订单可以被放弃 -->
    </update>

</mapper>