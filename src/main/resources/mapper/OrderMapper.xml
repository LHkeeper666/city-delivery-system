<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.thirdgroup.cdms.mapper.OrderMapper">
    <sql id="BaseColumnList">
        id, order_no, shop_name, shop_address, shop_phone,
        user_address, user_phone, profit, distance, status,
        courier_id, create_time, accept_time, complete_time
    </sql>

    <!-- 1. 查待接单订单（status=0，按距离升序） -->
    <select id="selectPendingOrders" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE status = #{status, jdbcType=INTEGER}
        ORDER BY distance ASC
    </select>

    <!-- 2. 查外卖员的配送中订单（status=1） -->
    <select id="selectDeliveringByCourierId" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE courier_id = #{courierId}
        AND status = #{status, jdbcType=INTEGER}
    </select>

    <!-- 3. 接单：更新订单的外卖员ID、状态、接单时间 -->
    <update id="acceptOrder">
        UPDATE delivery_order
        SET
        courier_id = #{courierId},
        status = #{status},
        accept_time = NOW()
        WHERE id = #{orderId}
        AND status = #{pendingStatus, jdbcType=INTEGER} <!-- 防重复接单：只更待接单状态的订单 -->
    </update>

    <!-- 4. 更新订单状态（确认取餐/送达） -->
    <update id="updateStatus">
        UPDATE delivery_order
        SET
        status = #{status},
        <if test="status == 2">complete_time = #{time}</if> <!-- 已完成：更新完成时间 -->
        WHERE id = #{orderId}
    </update>

    <!-- 5. 根据ID查订单 -->
    <select id="selectById" resultType="com.thirdgroup.cdms.model.DeliveryOrder">
        SELECT
        <include refid="BaseColumnList"/>
        FROM delivery_order
        WHERE id = #{orderId}
    </select>
</mapper>