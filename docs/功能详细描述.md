# 同城配送管理系统 — 功能详细描述

## 一、登录管理模块

### 
模块功能说明：
该模块为系统的入口模块，负责用户身份验证与权限控制，确保不同角色进入对应的功能模块。

主要功能描述：

1. 权限控制：
   - 系统根据用户身份区分配送员和系统管理员。
   - 配送员无法访问系统管理模块；管理员拥有系统的最高访问权限。

2. 登录错误信息提示：
   - 当用户输入错误的用户名或密码时，系统弹出相应错误提示信息。
   - 支持多次登录失败后的提示或限制登录操作（选做）。

### 功能 1：权限控制

**功能概述：**  
系统根据用户身份（配送员、系统管理员）进行访问权限控制。  
配送员仅能访问配送员模块；管理员可访问系统管理模块。  
此功能确保不同角色在系统中的操作边界，防止越权访问。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | 字符串 | 用户输入的账户名 |
| 密码 | 字符串 | 用户输入的登录密码 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 登录验证结果 | 布尔 | 表示验证是否通过 |
| 用户角色 | 枚举 | 系统识别的用户角色：`deliveryman` / `admin` |
| 跳转页面 | 页面 | 登录后根据角色跳转的目标模块主页 |

**主要流程：**

1. 用户输入用户名与密码提交登录请求。
2. 系统从数据库中验证用户名与密码是否匹配。
3. 若验证成功，系统判断该用户的角色类型：
   - 配送员：跳转至配送员模块；
   - 系统管理员：跳转至系统管理模块。
4. 若验证失败，则触发登录错误提示流程。
5. 权限控制模块在后续操作中持续生效，防止访问非授权页面。

**数据需求：**

| 数据表 | 主要字段 | 说明 |
| --- | --- | --- |
| `user` | user_id, username, password, role, status | 存储所有用户信息及其角色身份 |
| **关系** | - | `role` 用于区分用户类型（配送员、管理员） |

---

### 功能 2：登录错误信息提示

**功能概述：**  
在用户登录失败时，系统应返回明确的错误提示信息，帮助用户了解失败原因。  
可选功能包括：限制连续登录失败次数、防止暴力破解。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | 字符串 | 登录时输入的账户名 |
| 密码 | 字符串 | 登录时输入的密码 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 提示信息 | 字符串 | 登录失败原因（如“用户名不存在”或“密码错误”） |
| 登录状态 | 枚举 | 成功 / 失败 / 被锁定 |
| 剩余尝试次数（选做） | 数值 | 距离账号暂时锁定的剩余尝试次数 |

**主要流程：**

1. 用户提交登录信息后，系统验证用户名与密码。
2. 若用户名不存在，返回“用户不存在”提示。
3. 若密码错误，返回“密码错误”提示，并记录失败次数。
4. 若失败次数超过设定阈值（如3次），可临时锁定账户并提示用户稍后重试（选做）。
5. 登录成功后，系统清空该用户的登录错误计数。

**数据需求：**

| 数据表 | 主要字段 | 说明 |
| --- | --- | --- |
| `login_log`（选做） | user_id, attempt_time, success_flag, fail_count | 记录用户登录行为，用于限制连续失败登录 |
| `user` | user_id, username, password, status | 存储登录凭证及账户状态 |

---

## 二、系统管理模块

###
模块功能说明：
该模块为系统的核心管理后台，仅供具有“系统管理员”角色的用户访问。管理员在此模块中完成账号管理、订单生命周期管理以及数据统计分析工作，确保整个配送流程的顺畅与可控。

主要功能描述：

1.  账号管理：系统管理员能够对管理员账号和配送员账号进行全面的增、删、改、查及密码重置操作。
2.  发布配送信息：管理员可创建新的配送订单，填写详细的收发货地址、费用等信息，订单初始状态为"待接单"，进入抢单池。
3.  跟踪配送信息：管理员能够根据订单号、客户信息等多种条件查询订单，并实时跟踪其配送状态（如：待接单、配送中、已完成、取消）。
4.  历史配送信息查阅与统计：管理员能够查阅所有历史配送记录，并基于这些数据进行多维度统计。

### 功能1：账号管理

**功能概述：**  
系统管理员通过该功能对两类账号进行全生命周期管理，包括管理账号的增删改查、密码修改，以及配送员账号的创建、信息维护、状态管理（如启用/禁用），确保账号权限与业务角色精准匹配，避免越权操作。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 账号 ID | 字符串 / 数值 | 唯一标识，修改 / 删除 / 查询时必填|
|用户名 | 字符串 | 6-20 位字母 / 数字组合，不可重复 |
| 初始密码 / 新密码 | 字符串 | 8-20 位含字母 + 数字 + 特殊符号 |
|用户角色 | 枚举 | 固定为admin（管理账号）或deliveryman（配送员账号） |
| 配送员联系方式 | 字符串 | 11 位手机号，仅配送员账号需填写 |
|账号状态 | 枚举 | enabled（启用）/disabled（禁用） |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 操作结果提示 | 字符串 | 如 “账号新增成功”“用户名已存在”“密码修改成功” |
| 账号列表 | 列表 | 展示账号 ID、用户名、角色、状态、联系方式、创建时间 |
| 账号详情 | 对象 | 单个账号的完整信息（含加密后的密码，不可明文展示） |
| 操作日志（选做） | 字符串 | 记录 “谁在什么时间执行了什么操作”，用于追溯 |

**主要流程：**

1. 账号新增流程
   - 管理员选择账号类型（管理账号/配送员账号），填写用户名、初始密码、联系方式（仅配送员）等信息；
   - 系统校验用户名唯一性（查询user表），若已存在则返回错误提示；
   - 校验通过后，对密码进行加密处理，将账号信息存入user表，状态默认设为“启用”；
   - 返回“新增成功”提示，并刷新账号列表。
2. 账号查询/修改/删除流程
   - 查询：管理员输入账号ID、用户名或用户角色筛选，系统从user表查询匹配数据，以列表形式展示；
   - 修改：管理员点击目标账号“修改”按钮，修改允许变更的字段（如密码、联系方式、状态），系统校验后更新user表，返回成功提示；
   - 删除：管理员选择目标账号“删除”，系统校验该账号是否存在未完成的关联业务（如配送员账号是否有“配送中”任务），若无则删除user表中对应记录，若有则提示“存在未完成业务，无法删除”。
3. 密码修改流程
   - 管理员选择目标账号（或自己的账号），输入原密码（修改自身密码时）和新密码；
   - 系统校验原密码正确性（仅自身密码修改需校验），新密码符合复杂度要求后，加密更新user表中 password字段；
   - 返回“密码修改成功”提示。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | --- |
| `user` | user_id,username, password,role,status, contact_info（联系信息）,create_time（创建时间）,creator_id（创建人 ID ） | 存储所有用户账户信息。role 用于区分用户类型（配送员、管理员），status字段标识账号状态（启用/禁用）。 | 与登录管理模块共用该表 |
| `operation_log`（选做） | log_id, operator_id, operation_type, operation_obj, operation_time, result | 记录账号操作日志 | operator_id关联user表的user_id（操作人），operation_obj关联被操作账号的user_id |

---

### 功能2：发布配送信息

**功能概述：**  
系统管理员作为配送需求的发起方，通过该功能录入接货地址、配送地址、配送费用等核心信息，生成初始状态为“待接单”的配送单；可选将该功能封装为WEB SERVICE接口，供第三方应用（如商家系统）调用，实现配送需求的批量/自动接入。

**输入：**

| 输入项 | 类型 | 说明 | 必要性 |
| --- | --- | --- | --- |
|接货地址 | 字符串 | 含省、市、区、详细地址 | 必选 |
| 接货人姓名 | 字符串 | 接收货物的联系人姓名 | 必选 |
| 接货人电话 | 字符串 | 11 位手机号，用于联系接货 | 必选 |
| 配送地址 | 字符串 | 格式同接货地址，为货物最终送达地址 | 必选 |
| 收货人姓名 | 字符串 | 接收货物的联系人姓名 | 必选 |
| 收货人电话 | 字符串 | 11 位手机号，用于联系收货 | 必选 |
| 配送费用 | 数值 | 单位：元，保留 2 位小数 | 必选 |
| 货物类型 | 枚举 | ordinary（普通货物）/fragile（易碎品）/fresh（生鲜） | 必选 |
| 预计配送时效 | 数值 | 单位：小时 | 可选 |
| 货物重量 / 体积 | 数值 | 重量单位：kg，体积单位：m³，用于配送员参考 | 可选 |
| 备注信息 | 字符串 | 如 “需当面签收” “请勿挤压” | 可选 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 配送单编号 | 字符串 | 唯一标识（如 “DEL20251012001”，含日期 + 流水号） |
| 发布结果提示 | 字符串 | 如 “配送单发布成功，待配送员接单” |
| WEB SERVICE 接口响应（选做）（选做） | JSON/XML | 含code（状态码）、msg（提示）、order_id（配送单编号） |
| 配送单详情页） | 页面 | 展示已发布配送单的所有信息，状态标注为 “待接单” |

**主要流程：**
1.  管理员进入“配送信息发布”页面，填写完整的表单信息。
2.  点击“提交”后，系统对必填字段（如地址、联系方式）进行格式校验。
3.  校验通过后，系统生成唯一配送单编号（规则：前缀“DEL"+日期+3位流水号），将信息存入delivery_order表，状态设为“待接单”（status="pending"）。
4.  系统将订单数据持久化到数据库，并展示“发布成功”提示及配送单编号。
5.  （选做）WebService接口：提供标准接口，第三方系统传入规范参数即可创建订单，返回相同结构的响应。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | --- |
| `delivery_order` | order_id（配送单编号）, pickup_addr, pickup_name, pickup_phone, delivery_addr, delivery_name, delivery_phone,fee, goods_type, expected_time, weight, volume, remark, status, create_time, creator_id | 存储配送单核心信息。status记录订单生命周期状态。 | creator_id关联user表的user_id（发布人，即管理员），后续配送员模块需读取该表“待接单”数据 |
| `api_key`（选做） |key_id, app_name, api_key, status, create_time | 存储第三方应用的接口密钥 | 用于 WEB SERVICE 接口的身份验证，仅状态为“启用”的密钥可调用接口 |

---

### 功能3：跟踪配送信息

**功能概述：**  
系统管理员通过该功能实时查询配送单的当前状态（待接单/配送中/已完成/取消），并查看配送全流程节点信息（如“谁接单”“何时开始配送”“何时送达”），支持按多条件组合查询，确保对配送进度的实时管控。

**输入：**

| 输入项 | 类型 | 说明 | 查询逻辑 |
| --- | --- | --- | --- |
| 配送单编号 | 字符串 | 精确匹配（如 “DEL20251012001”） | 输入后优先按编号查询，结果唯一 |
| 接货人电话 | 字符串 | 11 位手机号，模糊匹配 | 可单独输入，或与其他条件组合 |
| 收货人电话 | 字符串 | 11 位手机号，模糊匹配 | 可单独输入，或与其他条件组合 |
| 配送员 ID / 姓名 | 字符串 | 匹配配送员账号的user_id或username | 仅查询该配送员负责的配送单 |
| 配送状态 | 枚举 | pending（待接单）/delivering（配送中）/completed（已完成）/cancelled（取消） | 筛选指定状态的配送单|
| 时间范围 | 日期区间 | 如“2025-10-01 至 2025-10-12” | 筛选该时间段内创建的配送单 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 配送单列表 | 列表 | 展示匹配条件的所有配送单，含订单号、接货地址（脱敏，如“北京市海淀区 ***”）、配送状态、创建时间 |
| 配送单详情 | 对象 | 点击列表项后展示，含所有字段（地址、联系人、货物类型、费用）+ 配送节点信息（接单时间、配送员、送达时间） |
| 空结果提示 | 字符串 | 如“未查询到符合条件的配送单，请调整查询条件” |

**主要流程：**
1.  管理员进入“配送信息跟踪”页面，选择查询条件（如输入配送单编号，或选择状态为“配送中”+时间范围）。
2.  点击“查询”按钮，系统根据输入条件拼接SQL查询语句，从delivery_order表和delivery_trace表（跟踪节点）关联查询。
3.  若有匹配数据，以列表形式展示核心信息；若无可匹配数据，返回空结果提示。
4.  管理员点击某配送单编号，跳转至详情页，系统展示该配送单的完整信息及所有跟踪节点（如“2025-10-12 10:00 配送单创建，待接单”“2025-10-12 10:30 配送员张三接单，状态变更为配送中”）。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | ---|
| `delivery_order` | order_id, pickup_addr, pickup_name, pickup_phone, delivery_addr, delivery_name, delivery_phone, fee, goods_type, status, create_time | 存储配送单基础信息 | 与配送员模块共用，配送员接单 / 完成后会更新status字段 |
| `delivery_trace` | trace_id, order_id, status, operator_id, operate_time, remark | 存储配送单状态变更的节点信息 | order_id关联delivery_order表的order_id，operator_id关联user表的user_id（操作人，如接单的配送员） |
| `user` |user_id, username, contact_info| 存储配送员姓名、联系方式 | 详情页展示“配送员信息”时，通过operator_id关联查询 |

---

### 功能4：历史配送信息查阅与统计

**功能概述：**  
系统管理员通过该功能查询所有已完成/已取消的历史配送单，并基于历史数据生成统计报表（如指定时间段内的总订单量、完成率、平均配送时长、各区域订单分布），支持数据导出（选做），为业务优化提供数据支撑。

**输入：**

| 输入项 | 类型 | 说明 | 统计维度关联 |
| --- | --- | --- | --- |
| 统计时间范围 | 日期区间 | 如“2025-09-01 至 2025-09-30” | 核心筛选条件，所有统计基于该时间段 |
| 配送状态 | 枚举 | 仅completed（已完成）/cancelled（取消） | 筛选历史订单的状态范围 |
| 区域范围 | 字符串 | 如“北京市海淀区”“上海市” | 按接货 / 配送地址的区域筛选 |
| 货物类型 | 枚举 | ordinary/fragile/fresh | 按货物类型分类统计 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 历史配送单列表 | 列表 | 展示符合条件的历史订单，含订单号、状态、接货 / 配送地址、费用、完成 / 取消时间 |
| 统计汇总表 | 表格 | 展示核心统计指标：总订单数、完成订单数、取消订单数、完成率（完成数 / 总数）、平均配送时长（完成订单的时长均值） |
| 统计图表（选做） | 饼图 / 柱状图 | 饼图：展示各状态订单占比；柱状图：展示每日订单量 / 各区域订单量；折线图：展示订单量趋势 |
| 数据导出文件（选做） | Excel/CSV | 包含历史订单列表或统计汇总表的完整数据，支持管理员下载 |


**主要流程：**
 1. 历史配送单查阅流程
   - 管理员进入“历史配送信息”页面，选择时间范围（默认近30天）、状态（默认“已完成”）等条件；
   - 点击“查询”，系统从delivery_order表查询状态为“已完成/取消”且在时间范围内的订单；
   - 以列表形式展示，支持按“完成时间”降序排序，管理员可点击订单号查看详情。
 2. 统计流程
   - 管理员在查阅页面点击“生成统计报表”，系统基于当前查询条件计算核心指标：
       - 总订单数：符合条件的订单总量；
       - 完成率：（完成订单数/总订单数）x100%；
       - 平均配送时长：所有完成订单的“送达时间-接单时间”的均值；
   - 系统以表格形式展示统计结果，可选生成饼图/柱状图（调用ECharts、Highcharts等插件）；
   - 管理员可点击“导出数据”，系统将统计结果或历史订单列表生成Excel/CSV文件供下载（选做）。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 统计逻辑依赖 |
| --- | --- | --- | --- |
| `delivery_order` | order_id, status, create_time, complete_time, cancel_time, pickup_addr, delivery_addr, goods_type, fee | 存储历史订单的核心数据 | 时间范围依赖create_time，状态依赖status，区域统计依赖pickup_addr/delivery_addr |
| `delivery_trace` |order_id, status, operate_time | 存储状态变更时间 | 平均配送时长计算依赖“接单时间”（status="delivering"的operate_time）和“完成时间”（status="completed"的operate_time） |
| `user` | user_id, username | 存储配送员信息 | 可选按“配送员”维度统计时，关联delivery_trace表的operator_id查询姓名 |

---

## 三、配送员模块
一、功能详细描述
1. 登录与安全认证模块

账号登录：配送员使用管理员分配的用，密码过期提示户名 / 初始密码登录，密码通过 MD5 加密传输


登录验证：校验账号有效性（存在性、是否禁用）及密码正确性，提示明确错误（如 “账号已禁用、密码过期提示、多次登录失败锁定提示”）

会话管理：登录成功创建 Session（30 分钟超时），存储配送员 ID、工作状态，超时自动登出

记住功能：Cookie 实现 “记住用户名”（有效期 7 天），下次登录自动填充

权限控制：添加 “角色标识” 字段（role_type：0 = 普通用户，1 = 配送员，2 = 管理员）。其中，普通用户（如消费者、商家）仅可访问 “订单查询（需手机号验证）、未接单取消” 功能，禁止访问系统管理模块及配送员专属模块，越权访问跳转 403 页面并提示 “无权限访问该模块”。

2. 个人信息管理模块

信息查看：展示姓名、联系方式、工作状态、紧急联系人、账号创建时间

信息修改：更新手机号/邮箱验证（若配送员账号已绑定邮箱，修改手机号时可选择 “邮箱验证”，系统发送验证码至绑定邮箱，输入正确后方可完成修改）、紧急联系人（需短信验证）

密码修改：验证原密码→输入新密码（6-16 位含字母 + 数字）→确认修改

状态管理：切换工作状态（在线 / 休息 / 离线），仅 “在线” 可接单

3. 配送任务处理模块

待接单列表：展示 “待接单” 订单（接货地址、配送地址、预估费用、发布时间）

任务筛选：按距离（近 / 中 / 远）、费用（高→低 / 低→高）、发布时间筛选

抢单功能：

自动抢单（系统开启时）：在线 +  “无‘配送中 / 已取货’状态的订单可抢单”，系统自动锁定订单

手动抢单（系统关闭时）：提交申请待管理员审核，审核通过锁定订单（系统抢单前先校验配送员当前订单状态，仅当无上述两类在途订单时，才允许参与自动抢单或提交手动抢单申请，避免配送员同时处理多个订单）

订单状态更新：

接单→“配送中”（记录 acceptTime）

取货→“已取货”（记录 pickUpTime）

完成→“已完成”（记录 completeTime）

核心异常处理：

配送员放弃订单：“配送中 / 已取货” 状态可发起，选原因（地址错误 / 突发疾病）+ 填说明→提交审核；审核通过→订单重回 “待接单”，驳回→恢复原状态

用户取消通知：用户取消已接单订单时，实时通知配送员（含订单号、原因），已取货订单获 30% 费用补偿

异常上报：上报 “联系不上收件人 / 物品损坏”，通知管理员→按指引处理（暂存 / 退回）

4. 配送记录查询模块

我的配送：

当前订单：展示 “配送中 / 已取货 / 放弃待审核” 订单，突出配送地址（加粗）、预计完成时间（超时标红）

历史订单：展示 “已完成 / 配送员放弃 / 用户取消” 订单，支持按 “近 7 天 / 30 天” 筛选，异常订单标红

详情查看：异常订单展示 “放弃 / 取消原因、审核结果 / 通知时间”

统计信息：今日 / 本月完成单量、平均完成时间、补偿金额

5. 系统通知模块

管理员操作通知：包括 “管理员修改了您的账号信息，请确认”“您的放弃订单申请已通过 / 驳回”“您的账号已被管理员禁用 / 启用”

订单状态通知：包括 “您有新的待接单订单，建议及时查看”“用户已取消您的在途订单，将获得 30% 费用补偿”“您的订单已超时，请尽快处理”

通知方式：配送员可在 “个人中心 - 通知设置” 中自定义短信通知开关

二、主要设计类图
+-------------------+       +-------------------+       +-------------------+
|   DeliveryMan     |       |       Order       |       |  LoginCredential  |
+-------------------+       +-------------------+       +-------------------+
| - id: String      |       | - orderId: String |       | - username: String|
| - username: String|       | - status: OrderStatus|<--+| - password: String|
| - password: String|       | - senderAddr: String    | +-------------------+
| - name: String    |       | - receiverAddr: String  |         ^
| - phone: String   |<--+   | - senderPhone: String   |         |
| - email: String   |   |   | - receiverPhone: String |         |  // 新增email属性（用于通知）
| - workStatus: WorkStatus| | - orderTime: Date       |         |
| - emergencyContact:String| | - acceptTime: Date      |         |
| - createTime: Date|   |   | - completeTime: Date    |         |
+-------------------+   |   | - pickUpTime: Date      |         |
| + login(cred: LoginCred)| | - estimatedTime: Date   |         |
|   : Boolean        |   |   | - deliveryManId: String|         |
| + updateInfo(newPhone: String,| | - fee: Double           |         |
|   newContact: String): Boolean| | - abortReason: String  |// 放弃原因
| + changePassword(oldPwd: String,| | - cancelReason: String|// 取消原因
|   newPwd: String): Boolean   | | - reviewerId: String  |// 审核人ID
+-------------------+   |   +-------------------+       |
        |               |   | + acceptOrder(manId: String)    |
        |               |   : Boolean                 |
        |               | + updateStatus(newStatus: OrderStatus, |
        |               |   time: Date): Boolean        |
        |               | + applyAbort(reason: String): Boolean |// 申请放弃
        |               +-------------------+           |
        |                      ^                         |
        |                      |                         |
        | +-------------------+ | +-------------------+   |
        | |   Notification   | | |  MyDelivery       |   |
        | +-------------------+ | +-------------------+   |
        | | - id: String      | | | - currentOrders:  |   |
        | | - deliveryManId: String  |   List<Order>     |   |
1对多  | | - content: String  | | | - historyOrders:  |   |
关系    | | - type: NotificationType|   List<Order>     |   |
        +-->| - isRead: Boolean  | | +-------------------+   |
            | - createTime: Date | | + getCurrentOrders(manId: String)|
            | - smsSent: Boolean | |   : List<Order>             |
            +-------------------+ | + getHistoryOrders(manId: String, |
            | + send(): Boolean  | |   timeRange: String): List<Order>|
            | + markAsRead(): Boolean | +-------------------+   |
            +-------------------+                               |
                                                                |
        +-------------------+       +-------------------+       |
        |AccountSecurityLog |       |  SystemConfig     |       |
        +-------------------+       +-------------------+       |
        | - id: String      |       | <<Singleton>>     |       |
        | - deliveryManId: String  | | - autoGrabEnabled:Boolean|
1对多  | | - loginTime: Date |       | - updateTime: Date |       |
关系    +-->| - loginDevice: String| +-------------------+       |
            | - loginIp: String  | | + getInstance():   |       |
            | - loginResult: String|   SystemConfig     |       |
            +-------------------+ | + updateConfig(    |       |
            | + addLog(): Boolean|   autoGrab: Boolean):Boolean|
            | + getRecentLogs(...)  | +-------------------+       |
            +-------------------+                               |
                                                                |
+-------------------+       +-------------------+           |
| NotificationType  |       |   WorkStatus      |           |
+-------------------+       +-------------------+           |
| <<Enumeration>>   |       | <<Enumeration>>   |           |
| - ADMIN_OPERATE   |       | - ONLINE          |<----------+
| - ORDER_STATUS    |       | - RESTING         |
+-------------------+       | - OFFLINE         |
                            +-------------------+
+-------------------+       
|   OrderStatus     |       
+-------------------+       
| <<Enumeration>>   |       
| - PENDING         |<------+
| - IN_DELIVERY     |       
| - PICKED_UP       |       
| - DELIVERED       |       
| - DELIVERER_ABORT |// 配送员放弃
| - USER_CANCEL     |// 用户取消
| - ABORT_PENDING   |// 放弃待审核
+-------------------+       

类图说明

核心实体类

DeliveryMan（配送员类）：封装与配送员相关的核心属性与操作，无冗余字段。

属性：id：String（唯一标识）、username（登录账号）、password（加密存储的密码）、name（真实姓名）、phone（联系方式）、workStatus（工作状态，关联WorkStatus枚举）、emergencyContact（紧急联系人）、createTime（账号创建时间）、updateTime（信息更新时间）

方法：login（登录验证，接收LoginCredential参数）、updateInfo（更新联系方式与紧急联系人）、changePassword（修改密码，需验证原密码），覆盖个人信息管理核心操作。

Order（订单类）：存储订单全生命周期数据，新增异常相关字段，满足核心异常场景需求。

属性：基础字段（orderId、senderAddr、receiverAddr等）+ 异常字段（abortReason配送员放弃原因、cancelReason用户取消原因、reviewerId审核人 ID），字段类型均为简单数据类型（字符串、日期），无复杂关联。

方法：acceptOrder（接单，关联配送员 ID）、updateStatus（更新订单状态，同步记录时间）、applyAbort（提交放弃申请，存储放弃原因），覆盖订单操作全流程。

Notification（通知类）：封装配送员通知相关数据，支持消息推送与状态管理。

属性：id（唯一标识，如 “NT202405201001”）、deliveryManId（关联配送员 ID）、content（通知内容）、type（通知类型，关联 NotificationType 枚举）、isRead（是否已读，默认 false）、createTime（创建时间）、smsSent（是否发送短信，默认 false）。

方法：send（发送通知，依赖 DeliveryMan 的 phone 和 email 属性，更新 smsSent 状态）、markAsRead（标记为已读，更新 isRead 状态），覆盖通知全生命周期操作。

枚举类型

OrderStatus（订单状态枚举）：仅保留核心状态，无多余值，覆盖正常与异常流程。

正常状态：PENDING（待接单）、IN_DELIVERY（配送中）、PICKED_UP（已取货）、DELIVERED（已完成）。

异常状态：DELIVERER_ABORT（配送员放弃）、USER_CANCEL（用户取消）、ABORT_PENDING（放弃待审核），与业务流程严格对应。

WorkStatus（工作状态枚举）：仅 3 类状态，控制接单权限，逻辑简洁。

ONLINE（在线，可抢单）、RESTING（休息，不可抢单）、OFFLINE（离线，不可登录操作）。

NotificationType（通知类型枚举）：明确通知场景，避免状态混乱。

包含值：ADMIN_OPERATE（管理员操作通知，如审核结果）、ORDER_STATUS（订单状态通知，如订单取消 / 完成），与业务通知场景一一对应。

功能支撑类

SystemConfig（系统配置类）：单例模式，仅控制抢单模式，无冗余配置。

属性：autoGrabEnabled（布尔值，控制自动 / 手动抢单）、updateTime（配置更新时间）。

方法：getInstance（获取单例实例）、updateConfig（更新抢单模式配置），确保全局配置唯一。

MyDelivery（我的配送类）：封装订单查询逻辑，简化数据处理。

属性：currentOrders（当前订单列表）、historyOrders（历史订单列表）。

方法：getCurrentOrders（查询当前订单，接收配送员 ID 参数）、getHistoryOrders（查询历史订单，支持时间范围筛选），避免重复查询逻辑。

LoginCredential（登录凭证类）：仅封装登录所需参数，简化方法传参。

属性：username（用户名）、password（密码），作为DeliveryMan.login方法的入参，清晰区分登录数据与配送员核心数据。

类间关系

一对多关系：1 个DeliveryMan可关联多个Order（通过Order.deliveryManId外键），符合 “一个配送员处理多个订单” 的业务逻辑。

关联关系：Order.status关联OrderStatus枚举、DeliveryMan.workStatus关联WorkStatus枚举，避免硬编码状态值，提升可维护性。

依赖关系：DeliveryMan.login依赖LoginCredential，MyDelivery依赖Order，均为弱依赖，降低耦合度。

三、数据持久层 ER 图及说明（配送员个人抢单模式开关设计）
+-------------------+       +-------------------+
|  delivery_man     |       |   notification    |
+-------------------+       +-------------------+
| PK id             |<----->| PK id             |
|    username       |   |   | FK delivery_man_id|
|    password       |   |   |    content        |
|    name           |   |   |    type           |
|    phone          |   |   |    is_read        |
|    email          |   |   |    create_time    |
|    work_status    |   |   |    sms_sent       |
|    emergency_contact|  |   +-------------------+
|    role_type      |   |
|    password_expire_time|  |   +-------------------+
|    login_fail_count|   |   |      order        |
|    account_lock_time|  |   +-------------------+
|    create_time    |   |   | PK order_id       |
|    update_time    |   |   | FK delivery_man_id|
|    grab_mode      |   |   |    status         |
+-------------------+   |   |    sender_addr    |
                        |   |    receiver_addr  |
                        |   |    sender_phone   |
                        |   |    receiver_phone |
                        |   |    order_time     |
                        |   |    accept_time    |
                        |   |    complete_time  |
                        |   |    pick_up_time   |
                        |   |    estimated_time |
                        |   |    fee            |
                        |   |    abort_reason   |
                        |   |    cancel_reason  |
                        |   |    reviewer_id    |
                        |   +-------------------+
                        |
                        |   一对多关系
                        | （1个配送员对应多通知/多订单）
ER 图说明

1. 核心表结构设计
（1）delivery_man（配送员表）

存储配送员基础信息及个人抢单模式开关，是系统用户核心表：

字段名	数据类型	约束 / 说明
PK id	VARCHAR(32)	唯一标识（如 “DM202405201001”），兼容分布式场景
username	VARCHAR(50)	唯一、非空，登录账号（如 “peisong001”）
password	VARCHAR(100)	非空，加密存储（如 BCrypt 哈希，提升安全性）
name	VARCHAR(50)	非空，配送员真实姓名
phone	VARCHAR(20)	非空，联系电话（用于短信通知）
email	VARCHAR(100)	可选，绑定邮箱（用于邮件通知与验证，新增字段）
work_status	TINYINT	非空，工作状态（0 = 在线，1 = 休息，2 = 离线），控制接单权限
emergency_contact	VARCHAR(100)	非空，紧急联系人及电话（如 “李四 13900139000”）
role_type	TINYINT	非空，角色类型（1 = 配送员），与管理员 / 用户角色区分（新增字段）
password_expire_time	DATETIME	可选，密码过期时间（如 90 天有效期，到期强制修改，新增字段）
login_fail_count	TINYINT	非空，连续登录失败次数（默认 0，重置条件：成功登录或锁定超时，新增字段）
account_lock_time	DATETIME	可选，账号锁定时间（连续失败 5 次后设置，锁定 1 小时，新增字段）
create_time	DATETIME	非空，账号创建时间（默认当前时间）
update_time	DATETIME	非空，信息最后更新时间（自动更新）
grab_mode	TINYINT	非空，抢单模式开关（1 = 自动抢单，0 = 手动抢单），CHECK 约束：grab_mode IN (0,1)

核心设计逻辑：通过id（唯一 ID）与grab_mode（开关状态）的绑定，实现 “每个配送员独立控制抢单模式”，像物理开关一样直接（1 开 / 0 关）。

约束保障：

grab_mode

通过

CHECK

约束限制只能为 0 或 1，避免无效值：

CONSTRAINT chk_grab_mode CHECK (grab_mode IN (0, 1))

（2）order（订单表）
存储订单全生命周期数据，与配送员表形成关联，字段设计保持简洁：
字段名	数据类型	约束 / 说明
PK order_id	VARCHAR(32)	主键，订单唯一标识（如 "OD202405201001"）
FK delivery_man_id	INT	外键，关联delivery_man.id（未接单时为 NULL）
status	TINYINT	非空，订单状态（0 = 待接单，1 = 配送中，2 = 已取货，3 = 已完成，4 = 配送员放弃，5 = 用户取消，6 = 放弃待审核）
sender_addr	VARCHAR(255)	非空，发货地址
receiver_addr	VARCHAR(255)	非空，收货地址（突出展示字段）
sender_phone	VARCHAR(20)	非空，发货人电话
receiver_phone	VARCHAR(20)	非空，收货人电话
order_time	DATETIME	非空，订单创建时间
accept_time	DATETIME	接单时间（状态变为配送中时记录）
complete_time	DATETIME	完成时间（状态变为已完成时记录）
pick_up_time	DATETIME	取货时间（状态变为已取货时记录）
estimated_time	DATETIME	预计完成时间（突出展示字段，用于超时提醒）
fee	DECIMAL(10,2)	预估配送费用
abort_reason	VARCHAR(255)	配送员放弃原因（仅状态为 4/6 时有值）
cancel_reason	VARCHAR(255)	用户取消原因（仅状态为 5 时有值）
reviewer_id	INT	审核人 ID（关联管理员表，仅状态为 4/6 时有值）

与配送员表关联：通过delivery_man_id外键建立一对多关系（1 个配送员可处理多个订单），抢单模式不影响订单本身的数据结构。


（3）notification（通知表）
存储配送员通知数据，支持消息状态跟踪，与配送员表一对一关联。
字段名	数据类型	约束 / 说明
PK id	VARCHAR(32)	唯一标识（如 “NT202405201001”，格式：NT + 日期 + 序号）
FK delivery_man_id	VARCHAR(32)	非空，外键关联delivery_man.id，级联查询配送员信息
content	VARCHAR(500)	非空，通知内容（如 “您的放弃订单申请已通过，订单已重回待接单池”）
type	TINYINT	非空，通知类型（0 = 管理员操作通知，1 = 订单状态通知），与NotificationType枚举映射
is_read	TINYINT	非空，是否已读（0 = 未读，1 = 已读），默认 0
create_time	DATETIME	非空，创建时间（默认当前时间）
sms_sent	TINYINT	非空，是否发送短信（0 = 未发送，1 = 已发送），默认 0，关联配送员phone字段
2. 表间关系设计

一对多关系：delivery_man.id（主表） → order.delivery_man_id（从表），通过外键约束确保数据一致性，体现 “一个配送员可处理多个订单” 的业务逻辑。

无其他关联：抢单模式仅通过delivery_man表的id和grab_mode字段控制，无需额外关联表，查询路径直接（通过配送员 ID 即可获取其抢单模式）。

notification 与 order：无直接关联，通过delivery_man_id间接关联。例如：订单状态变更时，先获取订单归属的配送员 ID，再向notification表插入对应通知，避免冗余存储订单 ID，减少表间耦合。

四、主要业务逻辑处理流程图
1. 登录流程
开始 → 输入用户名/密码 → 勾选"记住用户名"（可选） → 提交请求 →
 
2. 抢单流程
开始 → 进入待接单列表 → 选择目标订单 → 点击"抢单" →
┌─────────────────┐
│ 查system_config表，判断auto_grab_enabled │
└────────┬────────┘
         ├─自动抢单模式→┌─────────────────┐
         │              │ 检查配送员状态： │
         │              │ 1. work_status=在线？ │
         │              │ 2. 无"配送中/已取货"订单？ │
         │              └────────┬────────┘
         │                       ├─不满足→显示"无法抢单"→结束
         │                       │
         │                       └─满足→┌─────────────────┐
         │                               │ 检查订单状态=待接单？ │
         │                               └────────┬────────┘
         │                                        ├─已被抢→显示"抢单失败"→结束
         │                                        │
         │                                        └─可抢单→┌─────────────────┐
         │                                                 │ 事务：更新status=配送中+关联ID+记录acceptTime │
         │                                                 └────────┬────────┘
         │                                                          │
         └─手动抢单模式→┌─────────────────┐                        │
                        │ 提交抢单申请 → 等待审核 │                        │
                        └────────┬────────┘                        │
                                 ├─审核驳回→显示原因→结束                │
                                 │                                  │
                                 └─审核通过→执行上述事务→┌────────────┴─────────┐
                                                          │ 显示"抢单成功"→跳转订单详情 │
                                                          └────────────────┘
                                                          → 结束

3. 订单状态更新流程（取货 / 完成）
开始 → 进入"我的配送-当前订单" → 选择"配送中/已取货"订单 → 点击"更新状态" →
┌─────────────────┐
│ 选择更新类型（取货/完成） │
└────────┬────────┘
         ├─取货→┌─────────────────┐
         │      │ 验证：订单归属当前配送员？ │
         │      └────────┬────────┘
         │               ├─无权限→显示错误→结束
         │               │
         │               └─有权限→┌─────────────────┐
         │                        │ 更新order表：   │
         │                        │ 1. status=已取货 │
         │                        │ 2. pick_up_time=当前时间 │
         │                        └────────┬────────┘
         │                                 │
         ├─完成→┌─────────────────┐        │
         │      │ 验证：订单归属当前配送员？ │
         │      └────────┬────────┘        │
         │               ├─无权限→显示错误→结束
         │               │                 │
         │               └─有权限→┌────────┴────────┐
         │                        │ 更新order表：   │
         │                        │ 1. status=已完成 │
         │                        │ 2. complete_time=当前时间 │
         │                        └────────┬─────────┘
         │                                 │
         └─────────────────────────────────┘
                                          │
                                 ┌────────▼─────────┐
                                 │ 刷新订单列表（移至历史） │
                                 └────────────────┘
                                 → 结束
4. 订单状态变更通知流程
订单状态变更（如接单、完成、放弃审核通过） →
┌────────────────────────────────────-------------------------------─┐
│ 1. 从 order 表获取变更订单的 delivery_man_id 与状态信息   │
│ 2. 拼接通知内容（如 “您的订单 OD202405201001 已完成”）  │
│ 3. 确定通知类型（ORDER_STATUS/ADMIN_OPERATE） 
└─────────────┬────────────────────┘
│
┌────────────────▼────────────────────┐
│ 向 notification 表插入通知记录：        │
│ - id：生成唯一标识（NT + 日期 + 序号） │
│ - delivery_man_id：订单归属配送员 ID    │
│ - content：拼接好的通知内容            │
│ - type：对应通知类型（0/1）            │
│ - is_read：默认 0（未读）               │
│ - create_time：当前时间                 │
│ - sms_sent：默认 0（未发送）           │
└─────────────┬───────────────────------─┘
│
┌────────────────▼──────────────────-----──┐
│ 调用短信服务发送通知：                   │
│ 1. 通过 delivery_man_id 查配送员 phone     │
│ 2. 发送短信（含通知内容关键信息） │
│ 3. 发送成功后更新 notification 表 sms_sent=1 │
└────────────────┬───────────────────------─┘
│结束（通知记录已存储，短信已发送）

5. 配送员放弃订单流程
开始 → 进入"我的配送-当前订单" → 选择"配送中/已取货"订单 → 点击"申请放弃" →
┌─────────────────┐
│ 选择放弃原因（下拉）+填写说明 │
└────────┬────────┘
         │
┌────────▼────────┐
│ 提交申请→更新order表： │
│ 1. status=放弃待审核 │
│ 2. abort_reason=填写的原因 │
│ 3. 通知管理员处理 │
└────────┬────────┘
         │
┌────────▼────────┐
│ 管理员30分钟内审核 → │
└────────┬────────┘
         ├─驳回→┌─────────────────┐
         │      │ 更新status=原状态（配送中/已取货） │
         │      │ 显示驳回说明→通知配送员→结束 │
         │      └─────────────────┘
         │
         └─通过→┌─────────────────┐
                │ 事务：          │
                │ 1. status=配送员放弃 │
                │ 2. 清空delivery_man_id │
                │ 3. 记录reviewer_id=管理员ID │
                └────────┬────────┘
                         │
                ┌────────▼────────┐
                │ 订单重回"待接单"池 → 通知配送员+用户 → 结束 │
                └─────────────────┘
5. 我的配送查看流程
开始 → 点击"我的配送"菜单 →
┌─────────────────┐
│ 从Session获取当前配送员ID │
└────────┬────────┘
         │
┌────────▼────────┐
│ 分别查询order表数据： │
│ 1. 当前订单：status in (配送中,已取货,放弃待审核) │
│ 2. 历史订单：status in (已完成,配送员放弃,用户取消) │
└────────┬────────┘
         ├─当前订单→┌─────────────────┐
         │          │ 数据处理：       │
         │          │ 1. 突出展示receiver_addr（加粗） │
         │          │ 2. 对比当前时间与estimated_time，超时标红 │
         │          └────────┬────────┘
         │                   │
         └─历史订单→┌────────┴────────┐
                    │ 数据处理：       │
                    │ 1. 按complete_time/cancel_time倒序 │
                    │ 2. 异常订单标红（标注"配送员放弃"/"用户取消"） │
                    └────────┬────────┘
                             │
                    ┌────────▼────────┐
                    │ 分"当前订单"/"历史订单"Tab展示 → 结束 │
                    └─────────────────┘
6. 密码过期提醒流程

配送员登录成功后 →

┌────────────────────────────────────┐
│ 1. 从 delivery_man 表获取 password_expire_time │
│ 2. 计算剩余有效期（expire_time - 当前时间） │
└────────────────┬───────────────────┘
├─未设置过期时间→跳过提醒→结束
│
├─剩余有效期 > 7 天→不提醒→结束
│
└─剩余有效期≤7 天→
┌─────────────────────┐
│ 显示提醒弹窗： │
│ “您的密码将在 X 天后过期，请及时修改” │
│ 弹窗提供 “立即修改” 按钮 │
└────────┬────────────┘
├─点击 “立即修改”→跳转密码修改页→结束
│
└─关闭弹窗→结束
五、补充说明
一、并发抢单控制：解决 “超抢” 核心问题
1. 核心痛点
多配送员同时抢同一订单时，因数据库查询与更新存在时间差，易出现 “同一订单被多个配送员抢到” 的超抢问题，导致订单状态混乱、业务纠纷。
2. 关键技术方案（按可靠性优先级排序）
（1）数据库悲观锁（推荐，适合订单量中等场景）

原理：抢单时通过 SELECT ... FOR UPDATE 锁定订单记录，确保同一时间仅一个配送员能操作该订单，避免并发冲突。

实现步骤：

配送员发起抢单请求，系统执行 SQL：

-- 仅锁定“待接单”状态的订单，避免锁表
SELECT * FROM `order` 
WHERE order_id = #{orderId} AND status = 0  -- 0=待接单
FOR UPDATE;  -- 行级锁，仅锁定当前订单记录

若查询到订单（未被锁定），立即执行更新：

UPDATE `order` 
SET status = 1,  -- 1=配送中
    delivery_man_id = #{manId}, 
    accept_time = NOW() 
WHERE order_id = #{orderId};

若查询无结果（订单已被锁定 / 抢光），直接返回 “抢单失败”。

优势：逻辑简单、可靠性高，能 100% 避免超抢；

注意：需控制锁超时时间（如 5 秒），避免长期占用锁导致其他请求阻塞。

（2）数据库乐观锁（适合高并发订单场景）

原理：不主动加锁，通过 “版本号 / 状态校验” 判断订单是否被修改，适合订单量超 1000 单 / 分钟的场景。

实现步骤：

订单表新增 version 字段（初始值 0，每次更新 + 1）；

抢单时先查询订单及版本号：

SELECT order_id, status, version 
FROM `order` 
WHERE order_id = #{orderId} AND status = 0;

更新时校验版本号，仅当版本号匹配时才更新：

UPDATE `order` 
SET status = 1, 
    delivery_man_id = #{manId}, 
    accept_time = NOW(), 
    version = version + 1  -- 版本号自增
WHERE order_id = #{orderId} AND version = #{queryVersion}

若更新行数为 0（版本号已变，订单被抢），返回 “抢单失败”。

优势：无锁竞争，高并发下性能优于悲观锁；

注意：需处理 “重试逻辑”（如用户点击后抢单失败，可提示 “重试抢单”）。

（3）业务层前置过滤（辅助优化）

抢单前先通过 “配送员状态 + 距离” 过滤，减少无效并发请求：

仅允许 “在线且无在途订单” 的配送员进入抢单环节；

自动抢单时，仅推送 “配送员当前位置 3 公里内” 的订单（通过经纬度计算距离），避免跨区域抢单导致的无效竞争。
