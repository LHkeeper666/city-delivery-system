# 同城配送管理系统 — 功能详细描述

## 一、登录管理模块

### 
模块功能说明：
该模块为系统的入口模块，负责用户身份验证与权限控制，确保不同角色进入对应的功能模块。

主要功能描述：

1. 权限控制：
   - 系统根据用户身份区分配送员和系统管理员。
   - 配送员无法访问系统管理模块；管理员拥有系统的最高访问权限。

2. 登录错误信息提示：
   - 当用户输入错误的用户名或密码时，系统弹出相应错误提示信息。
   - 支持多次登录失败后的提示或限制登录操作（选做）。

### 功能 1：权限控制

**功能概述：**  
系统根据用户身份（配送员、系统管理员）进行访问权限控制。  
配送员仅能访问配送员模块；管理员可访问系统管理模块。  
此功能确保不同角色在系统中的操作边界，防止越权访问。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | 字符串 | 用户输入的账户名 |
| 密码 | 字符串 | 用户输入的登录密码 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 登录验证结果 | 布尔 | 表示验证是否通过 |
| 用户角色 | 枚举 | 系统识别的用户角色：`deliveryman` / `admin` |
| 跳转页面 | 页面 | 登录后根据角色跳转的目标模块主页 |

**主要流程：**

1. 用户输入用户名与密码提交登录请求。
2. 系统从数据库中验证用户名与密码是否匹配。
3. 若验证成功，系统判断该用户的角色类型：
   - 配送员：跳转至配送员模块；
   - 系统管理员：跳转至系统管理模块。
4. 若验证失败，则触发登录错误提示流程。
5. 权限控制模块在后续操作中持续生效，防止访问非授权页面。

**数据需求：**

| 数据表 | 主要字段 | 说明 |
| --- | --- | --- |
| `user` | user_id, username, password, role, status | 存储所有用户信息及其角色身份 |
| **关系** | - | `role` 用于区分用户类型（配送员、管理员） |

---

### 功能 2：登录错误信息提示

**功能概述：**  
在用户登录失败时，系统应返回明确的错误提示信息，帮助用户了解失败原因。  
可选功能包括：限制连续登录失败次数、防止暴力破解。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 用户名 | 字符串 | 登录时输入的账户名 |
| 密码 | 字符串 | 登录时输入的密码 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 提示信息 | 字符串 | 登录失败原因（如“用户名不存在”或“密码错误”） |
| 登录状态 | 枚举 | 成功 / 失败 / 被锁定 |
| 剩余尝试次数（选做） | 数值 | 距离账号暂时锁定的剩余尝试次数 |

**主要流程：**

1. 用户提交登录信息后，系统验证用户名与密码。
2. 若用户名不存在，返回“用户不存在”提示。
3. 若密码错误，返回“密码错误”提示，并记录失败次数。
4. 若失败次数超过设定阈值（如3次），可临时锁定账户并提示用户稍后重试（选做）。
5. 登录成功后，系统清空该用户的登录错误计数。

**数据需求：**

| 数据表 | 主要字段 | 说明 |
| --- | --- | --- |
| `login_log`（选做） | user_id, attempt_time, success_flag, fail_count | 记录用户登录行为，用于限制连续失败登录 |
| `user` | user_id, username, password, status | 存储登录凭证及账户状态 |

---

## 二、系统管理模块

###
模块功能说明：
该模块为系统的核心管理后台，仅供具有“系统管理员”角色的用户访问。管理员在此模块中完成账号管理、订单生命周期管理以及数据统计分析工作，确保整个配送流程的顺畅与可控。

主要功能描述：

1.  账号管理：系统管理员能够对管理员账号和配送员账号进行全面的增、删、改、查及密码重置操作。
2.  发布配送信息：管理员可创建新的配送订单，填写详细的收发货地址、费用等信息，订单初始状态为"待接单"，进入抢单池。
3.  跟踪配送信息：管理员能够根据订单号、客户信息等多种条件查询订单，并实时跟踪其配送状态（如：待接单、配送中、已完成、取消）。
4.  历史配送信息查阅与统计：管理员能够查阅所有历史配送记录，并基于这些数据进行多维度统计。

### 功能1：账号管理

**功能概述：**  
系统管理员通过该功能对两类账号进行全生命周期管理，包括管理账号的增删改查、密码修改，以及配送员账号的创建、信息维护、状态管理（如启用/禁用），确保账号权限与业务角色精准匹配，避免越权操作。

**输入：**

| 输入项 | 类型 | 说明 |
| --- | --- | --- |
| 账号 ID | 字符串 / 数值 | 唯一标识，修改 / 删除 / 查询时必填|
|用户名 | 字符串 | 6-20 位字母 / 数字组合，不可重复 |
| 初始密码 / 新密码 | 字符串 | 8-20 位含字母 + 数字 + 特殊符号 |
|用户角色 | 枚举 | 固定为admin（管理账号）或deliveryman（配送员账号） |
| 配送员联系方式 | 字符串 | 11 位手机号，仅配送员账号需填写 |
|账号状态 | 枚举 | enabled（启用）/disabled（禁用） |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 操作结果提示 | 字符串 | 如 “账号新增成功”“用户名已存在”“密码修改成功” |
| 账号列表 | 列表 | 展示账号 ID、用户名、角色、状态、联系方式、创建时间 |
| 账号详情 | 对象 | 单个账号的完整信息（含加密后的密码，不可明文展示） |
| 操作日志（选做） | 字符串 | 记录 “谁在什么时间执行了什么操作”，用于追溯 |

**主要流程：**

1. 账号新增流程
   - 管理员选择账号类型（管理账号/配送员账号），填写用户名、初始密码、联系方式（仅配送员）等信息；
   - 系统校验用户名唯一性（查询user表），若已存在则返回错误提示；
   - 校验通过后，对密码进行加密处理，将账号信息存入user表，状态默认设为“启用”；
   - 返回“新增成功”提示，并刷新账号列表。
2. 账号查询/修改/删除流程
   - 查询：管理员输入账号ID、用户名或用户角色筛选，系统从user表查询匹配数据，以列表形式展示；
   - 修改：管理员点击目标账号“修改”按钮，修改允许变更的字段（如密码、联系方式、状态），系统校验后更新user表，返回成功提示；
   - 删除：管理员选择目标账号“删除”，系统校验该账号是否存在未完成的关联业务（如配送员账号是否有“配送中”任务），若无则删除user表中对应记录，若有则提示“存在未完成业务，无法删除”。
3. 密码修改流程
   - 管理员选择目标账号（或自己的账号），输入原密码（修改自身密码时）和新密码；
   - 系统校验原密码正确性（仅自身密码修改需校验），新密码符合复杂度要求后，加密更新user表中 password字段；
   - 返回“密码修改成功”提示。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | --- |
| `user` | user_id,username, password,role,status, contact_info（联系信息）,create_time（创建时间）,creator_id（创建人 ID ） | 存储所有用户账户信息。role 用于区分用户类型（配送员、管理员），status字段标识账号状态（启用/禁用）。 | 与登录管理模块共用该表 |
| `operation_log`（选做） | log_id, operator_id, operation_type, operation_obj, operation_time, result | 记录账号操作日志 | operator_id关联user表的user_id（操作人），operation_obj关联被操作账号的user_id |

---

### 功能2：发布配送信息

**功能概述：**  
系统管理员作为配送需求的发起方，通过该功能录入接货地址、配送地址、配送费用等核心信息，生成初始状态为“待接单”的配送单；可选将该功能封装为WEB SERVICE接口，供第三方应用（如商家系统）调用，实现配送需求的批量/自动接入。

**输入：**

| 输入项 | 类型 | 说明 | 必要性 |
| --- | --- | --- | --- |
|接货地址 | 字符串 | 含省、市、区、详细地址 | 必选 |
| 接货人姓名 | 字符串 | 接收货物的联系人姓名 | 必选 |
| 接货人电话 | 字符串 | 11 位手机号，用于联系接货 | 必选 |
| 配送地址 | 字符串 | 格式同接货地址，为货物最终送达地址 | 必选 |
| 收货人姓名 | 字符串 | 接收货物的联系人姓名 | 必选 |
| 收货人电话 | 字符串 | 11 位手机号，用于联系收货 | 必选 |
| 配送费用 | 数值 | 单位：元，保留 2 位小数 | 必选 |
| 货物类型 | 枚举 | ordinary（普通货物）/fragile（易碎品）/fresh（生鲜） | 必选 |
| 预计配送时效 | 数值 | 单位：小时 | 可选 |
| 货物重量 / 体积 | 数值 | 重量单位：kg，体积单位：m³，用于配送员参考 | 可选 |
| 备注信息 | 字符串 | 如 “需当面签收” “请勿挤压” | 可选 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 配送单编号 | 字符串 | 唯一标识（如 “DEL20251012001”，含日期 + 流水号） |
| 发布结果提示 | 字符串 | 如 “配送单发布成功，待配送员接单” |
| WEB SERVICE 接口响应（选做）（选做） | JSON/XML | 含code（状态码）、msg（提示）、order_id（配送单编号） |
| 配送单详情页） | 页面 | 展示已发布配送单的所有信息，状态标注为 “待接单” |

**主要流程：**
1.  管理员进入“配送信息发布”页面，填写完整的表单信息。
2.  点击“提交”后，系统对必填字段（如地址、联系方式）进行格式校验。
3.  校验通过后，系统生成唯一配送单编号（规则：前缀“DEL"+日期+3位流水号），将信息存入delivery_order表，状态设为“待接单”（status="pending"）。
4.  系统将订单数据持久化到数据库，并展示“发布成功”提示及配送单编号。
5.  （选做）WebService接口：提供标准接口，第三方系统传入规范参数即可创建订单，返回相同结构的响应。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | --- |
| `delivery_order` | order_id（配送单编号）, pickup_addr, pickup_name, pickup_phone, delivery_addr, delivery_name, delivery_phone,fee, goods_type, expected_time, weight, volume, remark, status, create_time, creator_id | 存储配送单核心信息。status记录订单生命周期状态。 | creator_id关联user表的user_id（发布人，即管理员），后续配送员模块需读取该表“待接单”数据 |
| `api_key`（选做） |key_id, app_name, api_key, status, create_time | 存储第三方应用的接口密钥 | 用于 WEB SERVICE 接口的身份验证，仅状态为“启用”的密钥可调用接口 |

---

### 功能3：跟踪配送信息

**功能概述：**  
系统管理员通过该功能实时查询配送单的当前状态（待接单/配送中/已完成/取消），并查看配送全流程节点信息（如“谁接单”“何时开始配送”“何时送达”），支持按多条件组合查询，确保对配送进度的实时管控。

**输入：**

| 输入项 | 类型 | 说明 | 查询逻辑 |
| --- | --- | --- | --- |
| 配送单编号 | 字符串 | 精确匹配（如 “DEL20251012001”） | 输入后优先按编号查询，结果唯一 |
| 接货人电话 | 字符串 | 11 位手机号，模糊匹配 | 可单独输入，或与其他条件组合 |
| 收货人电话 | 字符串 | 11 位手机号，模糊匹配 | 可单独输入，或与其他条件组合 |
| 配送员 ID / 姓名 | 字符串 | 匹配配送员账号的user_id或username | 仅查询该配送员负责的配送单 |
| 配送状态 | 枚举 | pending（待接单）/delivering（配送中）/completed（已完成）/cancelled（取消） | 筛选指定状态的配送单|
| 时间范围 | 日期区间 | 如“2025-10-01 至 2025-10-12” | 筛选该时间段内创建的配送单 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 配送单列表 | 列表 | 展示匹配条件的所有配送单，含订单号、接货地址（脱敏，如“北京市海淀区 ***”）、配送状态、创建时间 |
| 配送单详情 | 对象 | 点击列表项后展示，含所有字段（地址、联系人、货物类型、费用）+ 配送节点信息（接单时间、配送员、送达时间） |
| 空结果提示 | 字符串 | 如“未查询到符合条件的配送单，请调整查询条件” |

**主要流程：**
1.  管理员进入“配送信息跟踪”页面，选择查询条件（如输入配送单编号，或选择状态为“配送中”+时间范围）。
2.  点击“查询”按钮，系统根据输入条件拼接SQL查询语句，从delivery_order表和delivery_trace表（跟踪节点）关联查询。
3.  若有匹配数据，以列表形式展示核心信息；若无可匹配数据，返回空结果提示。
4.  管理员点击某配送单编号，跳转至详情页，系统展示该配送单的完整信息及所有跟踪节点（如“2025-10-12 10:00 配送单创建，待接单”“2025-10-12 10:30 配送员张三接单，状态变更为配送中”）。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 与其他模块关联 |
| --- | --- | --- | ---|
| `delivery_order` | order_id, pickup_addr, pickup_name, pickup_phone, delivery_addr, delivery_name, delivery_phone, fee, goods_type, status, create_time | 存储配送单基础信息 | 与配送员模块共用，配送员接单 / 完成后会更新status字段 |
| `delivery_trace` | trace_id, order_id, status, operator_id, operate_time, remark | 存储配送单状态变更的节点信息 | order_id关联delivery_order表的order_id，operator_id关联user表的user_id（操作人，如接单的配送员） |
| `user` |user_id, username, contact_info| 存储配送员姓名、联系方式 | 详情页展示“配送员信息”时，通过operator_id关联查询 |

---

### 功能4：历史配送信息查阅与统计

**功能概述：**  
系统管理员通过该功能查询所有已完成/已取消的历史配送单，并基于历史数据生成统计报表（如指定时间段内的总订单量、完成率、平均配送时长、各区域订单分布），支持数据导出（选做），为业务优化提供数据支撑。

**输入：**

| 输入项 | 类型 | 说明 | 统计维度关联 |
| --- | --- | --- | --- |
| 统计时间范围 | 日期区间 | 如“2025-09-01 至 2025-09-30” | 核心筛选条件，所有统计基于该时间段 |
| 配送状态 | 枚举 | 仅completed（已完成）/cancelled（取消） | 筛选历史订单的状态范围 |
| 区域范围 | 字符串 | 如“北京市海淀区”“上海市” | 按接货 / 配送地址的区域筛选 |
| 货物类型 | 枚举 | ordinary/fragile/fresh | 按货物类型分类统计 |

**输出：**

| 输出项 | 类型 | 说明 |
| --- | --- | --- |
| 历史配送单列表 | 列表 | 展示符合条件的历史订单，含订单号、状态、接货 / 配送地址、费用、完成 / 取消时间 |
| 统计汇总表 | 表格 | 展示核心统计指标：总订单数、完成订单数、取消订单数、完成率（完成数 / 总数）、平均配送时长（完成订单的时长均值） |
| 统计图表（选做） | 饼图 / 柱状图 | 饼图：展示各状态订单占比；柱状图：展示每日订单量 / 各区域订单量；折线图：展示订单量趋势 |
| 数据导出文件（选做） | Excel/CSV | 包含历史订单列表或统计汇总表的完整数据，支持管理员下载 |


**主要流程：**
 1. 历史配送单查阅流程
   - 管理员进入“历史配送信息”页面，选择时间范围（默认近30天）、状态（默认“已完成”）等条件；
   - 点击“查询”，系统从delivery_order表查询状态为“已完成/取消”且在时间范围内的订单；
   - 以列表形式展示，支持按“完成时间”降序排序，管理员可点击订单号查看详情。
 2. 统计流程
   - 管理员在查阅页面点击“生成统计报表”，系统基于当前查询条件计算核心指标：
       - 总订单数：符合条件的订单总量；
       - 完成率：（完成订单数/总订单数）x100%；
       - 平均配送时长：所有完成订单的“送达时间-接单时间”的均值；
   - 系统以表格形式展示统计结果，可选生成饼图/柱状图（调用ECharts、Highcharts等插件）；
   - 管理员可点击“导出数据”，系统将统计结果或历史订单列表生成Excel/CSV文件供下载（选做）。

**数据需求：**

| 数据表 | 主要字段 | 说明 | 统计逻辑依赖 |
| --- | --- | --- | --- |
| `delivery_order` | order_id, status, create_time, complete_time, cancel_time, pickup_addr, delivery_addr, goods_type, fee | 存储历史订单的核心数据 | 时间范围依赖create_time，状态依赖status，区域统计依赖pickup_addr/delivery_addr |
| `delivery_trace` |order_id, status, operate_time | 存储状态变更时间 | 平均配送时长计算依赖“接单时间”（status="delivering"的operate_time）和“完成时间”（status="completed"的operate_time） |
| `user` | user_id, username | 存储配送员信息 | 可选按“配送员”维度统计时，关联delivery_trace表的operator_id查询姓名 |

---


好的，以下是完整、结构化排版后的 **《同城配送管理系统 - 配送员模块详细设计.md》** 文件内容，可直接保存为 `.md` 文件使用：

---

# 同城配送管理系统 - 配送员模块详细设计

---

## 一、功能详细描述

### 1. 登录与安全认证模块

**账号登录：**  
配送员使用管理员分配的用户名 / 初始密码登录，密码通过 **MD5** 加密传输。  

**登录验证：**  
校验账号有效性（存在性、是否禁用）及密码正确性，提示明确错误（如“账号已禁用”“密码过期提示”“多次登录失败锁定提示”）。  

**会话管理：**  
登录成功后创建 Session（30 分钟超时），存储配送员 ID、工作状态，超时自动登出。  

**记住功能：**  
通过 Cookie 实现“记住用户名”功能（有效期 7 天），下次登录自动填充用户名。  

**权限控制：**  
系统添加“角色标识”字段（`role_type`：0 = 普通用户，1 = 配送员，2 = 管理员）。  
- 普通用户仅可访问“订单查询、未接单取消”功能；
- 禁止访问系统管理及配送员专属模块；
- 越权访问时跳转至 403 页面并提示“无权限访问该模块”。  

---

### 2. 个人信息管理模块

**信息查看：**  
展示姓名、联系方式、工作状态、紧急联系人、账号创建时间。  

**信息修改：**  
更新手机号与紧急联系人。  

**密码修改：**  
验证原密码 → 输入新密码（6–16 位，包含字母与数字） → 确认并修改。  

**状态管理：**  
切换工作状态（在线 / 休息 / 离线），仅“在线”状态可参与接单抢单动作。  

---

### 3. 配送任务处理模块

**待接单列表：**  
展示系统中状态为“待接单”的订单，包括接货地址、收货地址、预估费用与发布时间。  

**任务筛选：**  
支持按距离（近 / 中 / 远）、费用（高→低 / 低→高）、发布时间等参数筛选。  

#### 抢单功能：

- **自动抢单（系统开启时）**  
  当配送员处于“在线”状态，且无进行中的订单（配送中/已取货），系统为其自动分配订单。  

- **手动抢单（系统关闭时）**  
  配送员可提交抢单申请，管理员审核通过后锁定该订单。  
  系统抢单前自动校验配送员当前状态，防止多任务冲突。  

---

**订单状态更新：**

| 动作 | 更新状态 | 记录时间字段 |
| --- | --- | --- |
| 接单 | 配送中 | acceptTime |
| 取货 | 已取货 | pickUpTime |
| 完成 | 已完成 | completeTime |

---

**核心异常处理：**

1. **配送员放弃订单：**  
   - 允许在“配送中”“已取货”状态下提交放弃申请；  
   - 填写放弃原因（地址错误 / 疾病等）与说明 → 管理员审核；  
   - 审核通过 → 订单回到“待接单”；驳回 → 恢复原状态。  

2. **用户取消通知：**  
   用户取消订单后系统实时通知配送员（含订单号与原因），若订单已取货，配送员获得费用 30% 作为补偿。  

3. **异常上报：**  
   当出现“联系不上收件人”或“物品损坏”等情况时，配送员可上报异常，系统发送通知至管理员，由其按流程决定后续操作。

---

### 4. 配送记录查询模块

**我的配送功能：**  
- **当前订单：** 展示“配送中”“已取货”“放弃待审核”订单，收货地址加粗显示，预测时间超时标红。  
- **历史订单：** 展示“已完成”“配送员放弃”“用户取消”订单，可按“近 7 天 / 30 天”筛选。  
- **详情查看：** 异常订单展示放弃/取消原因、审核结果、通知时间。  
- **统计信息：** 显示今日、本月完成单量、平均完成时间、补偿金额。  

---

### 5. 系统通知模块

**通知类型：**  
- 管理员操作通知：如账号修改、审核结果、账号启用/禁用提示；  
- 订单状态通知：如新待接单通知、订单取消补偿、订单超时提醒。  

**通知方式：**  
配送员可在“个人中心 - 通知设置”中配置短信通知开关。

---

## 二、主要设计类图
---
### 类说明

#### DeliveryMan（配送员类）
- **主要职责：** 封装配送员的核心属性与业务行为。
- **方法：**
  - `login()`：登录验证；
  - `updateInfo()`：更新联系方式；
  - `changePassword()`：修改密码。

---

#### Order（订单类）
- **主要职责：** 管理订单全生命周期。
- **方法：**  
  `acceptOrder()`、`updateStatus()`、`applyAbort()`。

---

#### Notification（通知类）
- **主要职责：** 管理消息推送与已读状态。
- **方法：**  
  `send()`、`markAsRead()`。

---

#### SystemConfig（系统配置类）
- **职责：** 控制系统抢单模式（单例设计）。  

---

#### MyDelivery（我的配送类）
- **方法：**  
  `getCurrentOrders()`、`getHistoryOrders()`。  

---

### 枚举类型

| 枚举名 | 说明 |
| --- | --- |
| **OrderStatus** | PENDING、IN_DELIVERY、PICKED_UP、DELIVERED、DELIVERER_ABORT、USER_CANCEL、ABORT_PENDING |
| **WorkStatus** | ONLINE、RESTING、OFFLINE |
| **NotificationType** | ADMIN_OPERATE、ORDER_STATUS |

---

## 三、数据持久层 ER 图及说明（含个人抢单模式设计）
---

### 1. delivery_man 表
---

### 2. order 表

| 字段名 | 类型 | 说明 |
| --- | --- | --- |
| 
---

### 3. notification 表
---

## 四、主要业务流程图

### 1. 登录流程
---

### 2. 抢单流程
---

### 3. 订单状态更新流程（取货 / 完成）
---

### 4. 订单状态变更通知流程
-
---

### 6. 我的配送查看流程
---

### 7. 密码过期提醒流程
---

## 五、补充说明：并发抢单控制

### （1）数据库悲观锁（推荐方案）

```sql
SELECT * FROM `order`
WHERE order_id = #{orderId} AND status = 0
FOR UPDATE;

UPDATE `order`
SET status = 1, delivery_man_id = #{manId}, accept_time = NOW()
WHERE order_id = #{orderId};
```

**说明：**  
通过行级锁控制同一时间仅一个配送员能成功抢单，防止“超抢”。

---

### （2）数据库乐观锁（高并发方案）

```sql
SELECT order_id, status, version
FROM `order`
WHERE order_id = #{orderId} AND status = 0;

UPDATE `order`
SET status = 1, delivery_man_id = #{manId}, version = version + 1
WHERE order_id = #{orderId} AND version = #{queryVersion};
```

**说明：**  
无锁机制通过版本号校验避免并发冲突，适合高订单量场景。

---

### （3）业务层前置过滤

仅允许：
- 在线；
- 无在途订单；
- 距离 3km 内的配送员参与抢单。

---

**文档作者：** {{IDENTITY}}  
**最后更新时间：** 2024 年  

---

是否需要我继续为该模块生成配套的 **数据库建表 SQL 脚本（MySQL）**？
